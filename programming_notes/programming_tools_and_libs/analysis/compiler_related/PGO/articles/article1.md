
# 1

Profile Guided Optimization (PGO) https://www.ibm.com/docs/en/openxl-fortran-aix/17.1.0?topic=compatibility-profile-guided-optimization-pgo
- > Profile guided optimization (PGO), also known as profile-directed feedback (PDF), is a compiler optimization technique in computer programming that uses profiling to improve program runtime performance. 
- > PGO is supported in IBM® Open XL Fortran for AIX® 17.1.0, and there are two ways to generate and use profile data. You can find more information on PGO at https://ibm.biz/clang-v13-manual#profile-guided-optimization. PGO data files generated in IBM Open XL Fortran for AIX 17.1.0 are incompatible with the PDF files in IBM XL Fortran for AIX 16.1.0 or earlier releases.
- > The **cleanpdf**, **showpdf**, and **mergepdf** commands are replaced by the **ibm-llvm-profdata** utility in IBM Open XL Fortran for AIX 17.1.0.
- > **Example:**
  ```sh
  $ cat x.f
  program main
     integer i
     read (*, *) i
     if (i > 5) then
        print *, 'i is bigger than 5'
     else
        print *, 'i is <= 5'
     end if
  end program
  ```
- > Specify the **`-qprofile-generate`** option to instruct the compiler to instrument the code that is being compiled.
  ```sh
  $ /opt/IBM/openxlf/17.1.0/bin/xlf95 x.f -Ofast -qlto -qprofile-generate
  ** main   === End of Compilation 1 ===
  1501-510  Compilation successful for file x.f.
  $ ./a.out 
  43
  i is bigger than 5
  $ ls
  a.out  default_15822680647147574778_0.profraw x.f
  ```
- > After the raw profile file is generated, run the **ibm-llvm-profdata** tool on the raw profile file to make it consumable by the compiler. If you have several raw profile files, use the **merge** command to combine these raw profile files into one file.
  ```sh
  $ /opt/IBM/openxlf/17.1.0/bin/ibm-llvm-profdata merge -o default.profdata default_15822680647147574778_0.profraw
  $ ls
  a.out default_15822680647147574778_0.profraw default.profdata x.f
  ```
- > Specify the **`-qprofile-use`** option to instruct the compiler to optimize the program using the instrumentation data.
  ```sh
  $ /opt/IBM/openxlf/17.1.0/bin/xlf95 x.f -Ofast -qlto -qprofile-use
  ** main === End of Compilation 1 ===
  1501-510 Compilation successful for file x.f.
  $
  ```
- > For the detailed usage of the **`-qprofile-generate`** and **`-qprofile-use`** options, refer to [`-qprofile-generate`](https://www.ibm.com/docs/en/SSWEZ2_17.1.0/compiler_ref_xlf/opt_profile_generate.html) and [`-qprofile-use`](https://www.ibm.com/docs/en/SSWEZ2_17.1.0/compiler_ref_xlf/opt_profile_use.html).
- > By default, the **-bcdtors:all** option is passed to the linker. Object files that are compiled with **-qprofile-generate** contain constructor functions that are generated by the compiler. As a result, the linker picks up any archive member built with **-qprofile-generate** that defines constructor or destructor functions. This might cause an issue that duplicated object files from archives are included in the final executable. To resolve this issue, specify the **-bcdtors:mbr** option together with **-qprofile-generate** on the link step. With the **-bcdtors:mbr** option, the linker does not pick up an archive member if it is not referenced or if it contains constructor functions with no reachable code.

Profile-guided optimization (PGO) using GCC on IBM AIX https://developer.ibm.com/articles/gcc-profile-guided-optimization-to-accelerate-aix-applications/

# 2

pgo.sh https://gist.github.com/daniel-j-h/c4b109bff0b717fc9b24
```sh
# Instrument binaries, pgo data to /data/pgo, serial make is important to not confuse the pgo generator
env CXXFLAGS='-march=native -fprofile-dir=/data/pgo -fprofile-generate=/data/pgo' cmake .. -DCMAKE_BUILD_TYPE=Release                   
make -j 1

# Run instrumented program, generate and write pgo data
./runIt

# Use profile data and feed into gcc, correct for threading counter noise, serial make is important to not confuse the pgo generator
env CXXFLAGS='-march=native -fprofile-dir=/data/pgo -fprofile-use=/data/pgo -fprofile-correction' cmake .. -DCMAKE_BUILD_TYPE=Release                   
make -j 1
```
