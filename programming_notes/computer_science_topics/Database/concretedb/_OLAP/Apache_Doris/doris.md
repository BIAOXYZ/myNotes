
# 文章

MPP 是什么？以 Doris 为例 https://www.ihnfsa.com/database/mpp-in-doris/
- > 实验室的 OLAP 项目被砍，不知之后是否还有机会再学习 OLAP。我会把这段时间看到的资料整理出来，第一篇就讲讲 MPP 以及分布式优化。本文主要来源于 Doris 在 B 站开设的[课程](https://space.bilibili.com/362350065/channel/collectiondetail?sid=296007)的第四讲和第八讲，该课程是了解 Doris 非常好的资料。
- > **MPP 在 Doris 中的应用**
  * > **Doris 的 share-nothing 架构**
  * > **MPP 架构中的查询流程**
    + > 为了实现并行查询，HASH JOIN 所在的 fragment 2 会有多个实例分别在不同节点执行。扫表所在节点与 HASH JOIN 所在节点间的数据传输由 DataStreamSink 和 Exchange 算子负责。
    + > 例如，join 条件为 tbl1.k1 = tbl2.k1，则 fragment 0 中的 DataStreamSink 算子计算元组中 k1 的哈希值，作为接收方的 ID。这样一来，哈希值相同的元组被传输到同一节点继续做 HASH JOIN。
    + > ***MapReduce 也包含类似过程，我们统一称为 Shuffle 操作***。
  * > **分布式查询优化**
- > **MPP vs. 批处理**
  * > **MPP 的缺陷**
    + > MPP 数据库为了高吞吐量和低时延，牺牲了并发性能和可扩展性。***有资料显示，<ins>对比当前的 MPP 系统和 Spark 这类系统（相同的硬件环境），Spark 普遍比 MPP 慢 3 到 5 倍</ins>。50 个节点的 MPP 集群，性能和 250 的节点的 Spark 集群性能相当，<ins>但是 Spark 集群规模可以超过 250 个节点，MPP 做不到</ins>***。
- > 存算分离？
  * > 存算分离架构的优点是计算集群和存储集群可独立地弹性扩展。***显然，传统 MPP 和批处理系统都不适应这样的要求。MPP 数据库存算耦合，而批处理系统不得不通过计算和存储部署在同一物理集群拉近计算与数据的距离，仅在同一集群下构成逻辑存算分离***。
  * > 国外的 Snowflake, Databricks 实现了存算完全分离，它们是如何做到的？又是如何保障高并发要求和高性能要求的呢？这里我挖一个坑，希望未来能谈一下这些产品的存算分离架构。
- > 参考资料
  * > Apache Doris 源码阅读与解析系列直播——第四讲 一条SQL的执行过程 https://www.bilibili.com/video/BV1Kr4y117SC/
  * > Apache Doris 源码阅读与解析系列直播—— 第八讲 查询优化器详解 https://www.bilibili.com/video/BV1Lr4y1Q7Ho/
- 合集·《Apache Doris 源码阅读与解析》 系列直播 https://space.bilibili.com/362350065/channel/collectiondetail?sid=296007

Apache Doris 创始人：何为“现代化”的数据仓库？ https://mp.weixin.qq.com/s/cMeyuOskrrRn5MPvDFcmDQ  【from `InfoQ`】
- > 在 12 月 14 日的 Doris Summit Asia 2024 上，Apache Doris 创始人 & PMC 成员马如悦在开场演讲中，围绕“现代化数据仓库”这一主题，指出 3.0 版本是 Apache Doris  研发路程中的重要里程碑，他将这一进展总结为`“实时之路”、“统一之路”和“弹性之路”`。详细介绍了所对应的核心特性的设计思考与应用价值，揭晓了 2025 年社区发展蓝图。
- > **最具影响力开源大数据项目之一**
  * > Apache Doris 自 `2013 年`创建至今已 10 年有余，截至目前，GitHub Stars 已近 13,000，社区的贡献者达到近 670 名，平均每月活跃贡献者超过 120 名。这一成就使其超越了 Spark、Kafka 等项目，成为开源大数据和数据库领域中月活开发者最多的项目。此外，***Apache Doris 在所有 Apache 项目中官网浏览量稳居第一***，2024 年 4 月网站 PV 高达 900w，可见其受欢迎程度。
- > **Real-Time，实时之路**
  * > **02 极速交互式分析性能**
    + > 相较于事务型数据库，分析数据库则更注重交互式分析体验。为提供更好的交互性分析，Apache Doris 在性能上不断优化，包括对向量化引擎、基于 CBO 的优化器、丰富的索引支持、单表/多表物化视图以及在 ARM 架构下的深度优化等。在这些能力的加持下，Apache Doris 在测试集中表现优异：
      - > 在 `ClickBench` 测试中，Apache Doris 分别在 2022、2024 年 10 月，在榜单上领先所有工业界数据库 。
      - > 在 `TPC-H` 测试中，***Apache Doris 在 Join 场景中表现优异，其性能约为 `Greenplum` 的 3 至 8 倍***。
      - > 在 `TPC-DS` 测试中， ***Apache Doris 性能较 `Trino/Presto` 提升了约 3 倍***。
- > **Unified，统一之路**
  * > **01 湖仓无界**
    + > "湖仓无界"，即 Lakehouse，是数据领域的全新概念。Apache Doris 作为一款现代化的数据仓库，凭借其独特的架构，完美诠释了这一理念。而 Apache Doris 之所以能被称为 Lakehouse，主要得益于其两大特性：
      - > 联邦查询能力：Apache Doris 通过扩展 Catalog 和存储插件，使用户无需将数据物理集中至统一的存储空间，在保持各数据源独立性的同时，仅借助 Apache Doris 即可实现多个异构数据源的统一分析，既可以直查外部表以及存储文件、也可以执行内表和外表以及外表相互之间的关联分析。此外。目前 Apache Doris 已经支持了 10 余种主流湖、仓、关系型数据库的连接器。
      - > 开放的数据湖特性：Apache Doris 引入高吞吐读写 API，也称之为 Data API 或 Storage API。打破了数据封闭性，使外部引擎能直接、高效地访问和存储 Doris 中的数据，无需受限于造成性能瓶颈的 JDBC/ODBC 协议。
  * > **02 半结构化数据分析**
- > **Elastic，弹性之路**
  * > **01 存算一体**
    + > 在存算一体时代，Apache Doris 便提供了弹性资源管理功能，先是推出了基于资源标签（Resource Tag）的物理隔离方案，***后在 2.1 版本中推出了 Workload Group 管理方案，能够基于 `CGroup` 技术在每台机器上实现 CPU 资源的硬限和软限***。在存储方面也很早便实现了冷热分层策略，热数据存储在成本更高的 SSD 盘上，而冷数据则存储在相对低成本的 HDD 盘甚至更为廉价的对象存储上，保存方式也从多副本变为单副本，冷数据无需占用宝贵的本地机器资源，从而避免了因扩充容量而购买更多机器的需求。
      >> 【[ :star: ][`*`]】 //notes：不知道是几几年的特性，反正看描述还不如我们当时在线扩容特性的资源池功能全面。
  * > **02 存算分离全新架构**
    + > ***而在 `3.0 版本`中，Apache Doris 开始支持存算分离模式***。基于云原生存算分离的架构，***用户可以通过`多计算集群`实现查询负载间的物理隔离以及读写负载隔离***，并借助对象存储或 HDFS 等低成本的共享存储系统来大幅降低存储成本。在存算分离架构中，元数据存储在 `FoundationDB`，数据则存储在 S3 等对象存储中。在这一架构下，FE 和 BE 节点均变得无状态，所有数据都存放于共享的对象存储，而非本地存储。同时，为了提升性能，Doris 引入了高速缓存机制。
    + > 针对存算分离是否会影响性能的问题，我们进行了存算一体模式和存算分离模式在不同缓存下的 `TPC-DS` 1TB 性能测试。***结果显示，在缓存命中的情况下，性能基本无损；部分命中缓存时，性能损耗约为 `10%`；而在缓存不命中的情况下，性能损失约为 `30%`***。但相较于业内其他同类系统，存算分离模式下的 Apache Doris 仍有着极为明显的性能优势。
      >> 【[ :star: ][`*`]】 //notes：这个算是用数据说明了存算分离构架的最大劣势（之一）：影响性能。看数据我觉得影响还是挺大的，而且后面也提到业内其他系统更差。。。
    + > ![](https://mmbiz.qpic.cn/sz_mmbiz_png/Uecg6b8kbSYQe8PXiar16rKfuvEuHoBG2jOZJK1arlTZFsqb545Ll35amlNqNQpVtavcFGopsM2RDN2CTVRyKHg/640)
  * > **03 两种部署形态融合**
    + > 弹性的资源管理始终是数据分析基础设施的永恒追求。我们提供存算一体和存算分离两种部署形态，以便发挥各自的优势：***存算一体部署简便且性能优越，而存算分离则支持灵活的独立扩缩容***。
    + > 进一步来看，存算分离的部署需要依赖高性能的对象存储或文件系统，以及充足的网络带宽。如果企业的存储基础设施或网络带宽受限，存算分离的性能可能受到影响。***这也解释了为何存算分离常与云原生技术相关联，虽然存算分离并非云原生特有，但云原生环境为其提供了高带宽和优质对象存储，为其提供了理想的设施基础***。
    + > 当前，一些用户认为在开始时就要选择存算一体或存算分离的部署形态并不合理，尤其是在数据量较小时。因此，Apache Doris 未来计划融合这两种部署形态，用户无需再纠结于选择哪种部署形态。无论是从存算一体切换到存算分离，还是反向切换，都可以通过简单的参数配置实现自动切换，而无需重建集群或重新导入数据。
- > **2025，探索更多可能性**
  * > 展望 2025，在功能需求上，Apache Doris 将更加专注于用户需求，聚焦四大板块，强化其技术实力：
    + > 内置 CDC 同步：Apache Doris 虽已支持丰富的数据导入方式，但 CDC 仍依赖外部工具或生态合作伙伴。未来将实现内置 CDC 同步功能，目前我们已研发出初步版本，支持从众多 TP 数据库直接 CDC 导入数据。
    + > 支持增量数据处理：投入大量人力支持基于增量式的批量处理。这种方式不同于 Spark 或传统 Hive 的批量模式，具备更高的时效性，能够显著提升数据处理效率。
    + > 完善湖仓一体：兼容 `Trino/Presto Connector 框架`，***这意味着 Apache Doris 将能够直接使用 Trino 和 Presto 所支持的功能，无需重复开发***。同时，还将完善高吞吐读写的 Data API，以提升整体性能。
    + > 存算一体和存算分离部署形态融合：Apache Doris 未来计划融合这两种部署形态，用户无需再纠结于选择哪种部署形态，无论是从存算一体切换到存算分离，还是反向切换，都可以通过简单的参数配置实现自动切换，而无需重建集群或重新导入数据，避免架构过早复杂性。

# 现实案例

从 ClickHouse 到 Apache Doris：在网易云音乐日增万亿日志数据场景下的落地 https://mp.weixin.qq.com/s/F4d34ihLjhQZwy1v0Mm8lw  【from `InfoQ`】
- > 为寻找更优质解决方案，结合当前的业务需求，网易云音乐引入 Apache Doris 作为日志库新方案，替换了 ClickHouse。目前已经稳定运行 3 个季度，规模达到 50 台服务器，`2PB` 数据，每天新增日志量超过`万亿`条，峰值写入吞吐达 `6GB/s`。本文将介绍从 ClickHouse 到 Apache Doris 的迁移思考及调优实践，并分享网易云音乐如何在运维效率、并发能力、查询响应以及存储性能上实现全方位提升。
