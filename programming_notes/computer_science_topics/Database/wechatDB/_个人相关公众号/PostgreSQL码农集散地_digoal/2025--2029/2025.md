
# 01

遇到炫技的面试官，千万别这样答！ https://mp.weixin.qq.com/s/WD3agUUkr-KOp1JRa8vqRw
- > `情况1`, PostgreSQL数据库正在执行long query时, 如果客户端(主动/被动)断开与PostgreSQL的socket连接, 或者中间网络设备断开了这条连接, 请问PG数据库有什么反应?
  ```console
  1、继续执行long query
  2、直到执行完long query, 然后send data, 发现socket连接不正常
  3、断开连接
  ```
  * > 有没有什么方法让PG更快的发现客户端连接已经断了? 立即终止执行long query呢?有, 例如配置
    + > `tcp_keepalives_idle = 10s` # 如果这个socket连接10s都没有数据, 操作系统内核将发起心跳包
    + > `tcp_keepalives_interval = 5s` # 如果心跳包没有收到客户端回包, 间隔5s后再次发送
    + > `tcp_keepalives_count = 3` # 重试3次还没有收到回包, 操作系统内核将这个socket置为close状态. 当前配置也就是10+5+5+5=25s后发现问题并close socket.
    + > `client_connection_check_interval = 10s` # `PG 14`引入的参数. 数据库每10s检查socket状态, 如果发现close, 则停止正在执行的query, 释放数据库服务端的socket.
  * > 如果没有配置 `client_connection_check_interval` 的话, 要等数据库进入等待客户端消息或向客户端发送消息时, 才能发现socket问题, 也就是long query执行完.
- > `情况2`, PostgreSQL数据库正在执行long query时, 如果客户端(主动并发起SIG cancel 信号, 不管它怎么发的, 例如通过Libpq协议)断开与PostgreSQL的socket连接, 请问PG数据库有什么反应?
  * > 这里提到了cancel 信号, 那就要分2种情况
    + > 1、如果PostgreSQL 处于不接收中断信号的执行过程, 则暂不响应中断信号, query会继续执行完.
    + > 2、如果PostgreSQL 处于可接收中断信号的执行过程, 则会立即cancel query.
