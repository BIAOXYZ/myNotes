
# SQL注入

~~预编译SQL为什么能够防止SQL注入 https://www.cnblogs.com/Createsequence/p/16963891.html~~  【//已转移】

预编译与sql注入 https://fushuling.com/index.php/2023/10/27/%E9%A2%84%E7%BC%96%E8%AF%91%E4%B8%8Esql%E6%B3%A8%E5%85%A5/
- > 有次刷微信看到一篇文章：预编译真的能完美防御SQL注入吗？
- > 这里面提到一个很有趣的点——预编译是将sql语句参数化，刚刚的例子中 where语句中的内容是被参数化的。这就是说，预编译仅仅只能防御住可参数化位置的sql注入。那么，对于不可参数化的位置，预编译将没有任何办法。
- > 那么哪些是不可参数化的位置呢，原作者说：
  ```console
  那么不可参数化的位置都有哪些？
  1.表名、列名
  2.order by、group by
  3.limit
  4.join
  5.等

  我们以order by举例，现在有一个sql语句如下（以下为伪代码）
  SELECT * FROM users ORDER BY {user_input};

  其中user_input是传递过来的参数，例如 id
  SELECT * FROM users ORDER BY id;

  这个语句是正确的，但是如果user_input输入 id;drop table users --
  SELECT * FROM users ORDER BY id;drop table users --

  这样就被成功注入了，而这种位置是不可被参数化的，所以是无法通过预编译防御的。
  ```
- > 为了研究原理，我找到了一篇文章，这个应该是最早提出order by后没法参数化所以可以被sql注入的(其他文章都是相互抄，我们简中是这样的)—— SQL预编译中order by后为什么不能参数化原因，文章里是这么解释的
- > ***大概就是说，order by后面的字段是不能加引号的，而预编译后会自动加上引号，因为这个矛盾所以order by的后面不能进行预编译***。不过当时他解释原因是因为自动加引号的 `setString()` 方法，***而这个方法似乎只是java下存在的，而这篇文章我准备从原理出发研究研究php下的注入可能(其实这种思路不同语言是共通的)***
- > **无法预编译的位置**
  * > order by在底层查询过程中是直接把order by后面这个值进行利用然后排序，如果加上引号的话数据库会索引失败，查询结果其实等同于order by NULL或者order by TRUE，本质上是一条不合法的请求。因此无论是order by还是group by，他们后面的参数都是不能带引号的，而预编译中参数绑定的过程会自动给它们带上引号，这就导致这些位置上的参数是不能被预编译的，因为它的执行结果是错误的。所以渗透的时候遇到疑似排序的功能我们可以大胆的去尝试sql注入，一般都能成功。
  * > 总而言之就一个思路，不能加引号的位置就不能预编译。这里我们就可以看出预编译很明显的缺陷，当然，我们也不能错怪预编译的设计者们，因为这玩意儿本来设计之初就不是给你防注入，是用来在大批量查询时减少语法树构造的，因此出现差错也是可以理解的，当然这种差错就给了黑客可乘之机。
  * > 这里再引申一下，对于order by、ground by这种无法进行预编译的场景我们该怎么防御呢，比如Mybaits必须使用${}order by参数，可通过白名单思路对传入的参数进行判断，或者使用间接对象引用，***前端传递引用数字等，用于与后端排序参数做数组映射，避免前端直接传入order by参数造成sql注入***。
  * > ***比如我们想执行`select xx order by name`，那么前端就不要传入name这个值，而是数字比如1，然后在后端将1与真正想查询的参数name进行对应，然后再执行sql语句***。比如映射表为1->name，2->age，3->gender，想要查询order by name、age、gender的结果前端只用传入1、2、3即可，通过防止直接执行用户传入的值来从根本上防止sql注入的产生。(order by后的注入在我实习期间在xhs真实出现过，当时的解决办法就是间接引用)

:u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272:
