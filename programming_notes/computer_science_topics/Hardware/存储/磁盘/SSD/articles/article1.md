
# 1

【[:star:][`*`]】 固态硬盘为啥这么快？带你了解固态硬盘的“秘密”…… https://mp.weixin.qq.com/s/Dr2VVYZeG7U-lINxyL20Sg  【from： `服务器及存储专题` https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MjM5MTQ0MTQ2Mg==&action=getalbum&album_id=2386342673747247107】
- > **1 机械硬盘的工作原理**
  * > 机械硬盘在工作的时候，磁头会悬浮于磁盘面上方几纳米的距离。磁盘面上有很多的小格子，小格子内有很多的小磁粒。
  * > 这些磁盘上的磁粒有一定的极性，**当磁粒极性朝下的时候记为0，磁粒极性朝上的时候记为1，这样磁头就可以通过识别磁盘磁粒的极性读取数据了**。 <br> ![](https://mmbiz.qpic.cn/mmbiz_png/GOHsECYibE4RcSN6Jicy1b3pyFQfFCvBEo5lRpbCr9G0tk8JY6hseAJZlhBibSicqiblIBZ21Np0pAxlPtia3IzMzYicA/640)
  * > 而磁头也可以利用其变化的磁场改变磁盘磁粒的极性，这样就做到写入和改写磁盘数据了。 <br> ![](https://mmbiz.qpic.cn/mmbiz_png/GOHsECYibE4RcSN6Jicy1b3pyFQfFCvBEoylbiaq5hHqD5hYr990ibZniceVFxBWDWMianVWmccaWMJjpRddhhLqhKsw/640)
  * > 为了能够精准定位数据所在磁盘面上的位置，磁盘本身又被划分了无数的扇区和磁道。
  * > 假设数据存放在磁盘的第五磁道的第七扇区上： <br> ![](https://mmbiz.qpic.cn/mmbiz_png/GOHsECYibE4RcSN6Jicy1b3pyFQfFCvBEo3ibYPvSY5Zgae6DPkWdTxzibzb6ibWSX8KpTOZd0AwInqqkbT3hHy1ypg/640)
  * > 那磁头就会先摆动到第五磁道上空，然后等待第七扇区转过来。当第七扇区转到磁头下面的时候，才可以读取数据。
  * > 而固态硬盘同机械硬盘的工作原理完全不同，***固态硬盘采用纯电子结构***。
- > **2 固态硬盘的工作原理**
  * > 固态硬盘存储数据的基本单元叫**浮栅晶体管**，基本结构有：**存储电子的浮栅层**，**控制极G**、**衬底P**、**源极D**与**漏极S**。 <br> ![](https://mmbiz.qpic.cn/mmbiz_png/GOHsECYibE4RcSN6Jicy1b3pyFQfFCvBEoRsg0r9dfrrgTQ79oHH777c8x82GJicIpSbo6Sr4yHUIagKjN6QoZRJQ/640)
  * > **我们将`浮栅层`中的<ins>电子数量`高于`一定值计为`0`，`低于`一定值计为`1`</ins>**。 <br> ![](https://mmbiz.qpic.cn/mmbiz_jpg/GOHsECYibE4RcSN6Jicy1b3pyFQfFCvBEogHRgiavJHs5EpP3yZVQA1SxuvWCnKA2NRRdpicQD1SfBElgfBLwsFSFw/640)
    >> //notes：TODO: 所以固态硬盘的每个比特位的初始值都是 `1` 吗？
- > **写入数据**
  * > 写入数据时，需要在`控制极G`施加一个高压，这样电子就可以穿过`隧穿层`，进入`浮栅层`，因为有`绝缘层`的存在，电子不能再向前移动了，就被囚禁在了`浮栅层`。 <br> ![](https://mmbiz.qpic.cn/mmbiz_png/GOHsECYibE4RcSN6Jicy1b3pyFQfFCvBEo8fqHIvCueaJOK1ube1rpSuLNzic0QLP176dTelLDukTLT8ZXJsBK4Xw/640)
  * > 而当我们把电压撤去，这些电子依然会被囚禁在`浮栅层`，因为`隧穿层`本质上也相当于绝缘体，所以电子们只能被关押着，这样一位数据就被存储进去了。
  * > **这些电子能被“囚禁”多长时间也就是固态硬盘能够存储数据的年限，一般一块新的固态硬盘能够保存数据的年限为`10年`**。因为随着时间的流逝，不断地有电子“越狱”成功。
  * > 等“越狱”的电子多到一定的数量，我们保存的数据就不见了。
- > **擦除数据**
  * > 我们擦除固态硬盘上的数据其实就是在释放这些可怜的电子，即在`衬底`上施加高压，这样电子被吸出来，信息也就被擦除了。 <br> ![](https://mmbiz.qpic.cn/mmbiz_png/GOHsECYibE4RcSN6Jicy1b3pyFQfFCvBEogkXyTPd0q3XJLxlj9xn18yxWeYXibCG79SBbLicXf19RT8iaStV6Et9xA/640)
- > **读取数据**
  * > 关于它读取数据的原理也非常简单。
  * > 当`浮栅层`中不存在电子时（***存储数据为`1`***），我们给`控制极`一个低压，由于电压低，电子只能被吸引到靠近`隧穿层`的位置，却无法穿过`隧穿层`，因而`源极`-`漏极`可以导通，形成电流。
  * > **如果检测到电流，那么说明它没有储存电子，则读取数据为`1`**。 <br> ![](https://mmbiz.qpic.cn/mmbiz_png/GOHsECYibE4RcSN6Jicy1b3pyFQfFCvBEoUt8CfmfUVRiaJ0LibnldQNq5aYdS6LHZ9RsVVut13FKMQ8coZh7SsyXg/640)
  * > 当`浮栅层`中存在电子时（***存储数据为`0`***），我们还给`控制极`一个低压，由于`浮栅层`里面的电子对这些电子有排斥作用，所以电子无法被吸引到靠近`隧穿层`的位置，`源极`-`漏极`不会导通，不会形成电流。
  * > **如果无法检测到电流，那么说明浮栅层储存一定量电子，则读取数据为`0`**。 <br> ![](https://mmbiz.qpic.cn/mmbiz_png/GOHsECYibE4RcSN6Jicy1b3pyFQfFCvBEob154kV42mCYA2tQ5Q1jOxW8belDj4t5jqd2uXusVwUuYafreicQiboIw/640)
  * > 无数的浮栅晶体管堆叠在一块就可以存储大量的0和1，它们就类似于图书馆当中的书架一样，存储着无限的0101数据。
  * > **相对于机械硬盘这种机械结构，固态硬盘这种纯电子结构在存取速度方面的优势就非常突出**。在机械硬盘在读取数据之前，需要先摆动磁头臂到对应的磁道上方，再等待对应的扇区转过来。尽管目前的机械硬盘大部分都是`7200转/分钟`或者`5400转/分钟`的，看起来已经很快了，但是这两个操作依然会导致大约`十几毫秒`的延迟。这种延迟对于人类来讲确实微不足道，但是对于计算机内存和CPU来讲，就确实会产生显著影响。
  * > **而固态硬盘全程都是电子交互，电子信号的速度要远超磁头臂和磁盘这种机械结构**。如果你的数据是随机分散在磁盘的各个角落，那机械硬盘需要经过多次的寻道和寻址，多次等待扇区转动到磁头底下，所以机械硬盘在读取分散性文件的时候，性能就显得非常弱，速度很慢，**即随机读写性能低下**。
- > 了解固态硬盘的原理之后，**想必你一定知道为什么固态硬盘有擦写次数限制**？（点击下方空白处查看答案）
  * > ***是因为在浮栅晶体管擦写的过程中，电子反复在`隧穿层`反复进出，导致`隧穿层`损坏，不能有效的阻拦电子，失去了`隧穿层`应有的作用***。
- > 最后考你一个小问题，据说只有聪明的小伙伴才能回答出来～欢迎在评论区作答：**同一型号的两块固态硬盘，分别是1TB容量和500GB容量，哪一个的使用寿命更长，为什么**？
- 回复里的：
  * > 当然是大容量的固态硬盘寿命更长。相同的闪存颗粒，有效写入的pe次数自然是一样的。硬盘拥有更大的存储空间时，在全局均衡磨损算法的帮助之下。相对应的单个存储单元写入次数会更少，从而达到更久的使用寿命。
  * > 1tb寿命更长吧。假设对1tb和500g的硬盘同时刷写1tb的“0”数据，1tb的硬盘只隧穿了一次，而500的隧穿了两次，肯定更容易坏啊。
  * > 固态听说固态长时间不通电……所有电子都会跑光光
  * > 1TB寿命长，因为晶体管数量多的多。假设每个晶体管的可擦写次数相当，那么晶体管越多寿命越长
  * > 1Tb 有更多的空间存放数据，平均被读写的频率小

# 2

了解 SSD 技术：NVMe、SATA、M.2 https://www.kingston.com.cn/cn/ssd/what-is-nvme-ssd-technology
- > **NVMe 的优势**
  * > NVMe 技术带来出众的存储空间、速度和兼容性。***由于 `NVMe` 利用 `PCIe` 插槽，它传输的数据量是同等 `SATA` 产品的 `25 倍`***。除了更多数据，***`NVMe` 命令的速度是 `AHCI` 驱动程序命令的 `2 倍`***。此外，***NVMe 的`每秒输入/输出操作 (IOPS)` 超过 `100 万`，是 AHCI 硬盘的 `900%`***。得益于自身的兼容性，***NVMe 还直接与系统 CPU 通信***，具有惊人的速度。NVMe 硬盘兼容所有主要的操作系统，无论外形尺寸如何。
  * > ***NVMe (`Non-Volatile Memory Express`) <ins>是一种通信接口和驱动程序</ins>，可充分利用 PCIe 提供的更高带宽***。它旨在提高性能和效率，同时让广泛的企业级系统和客户端系统实现互操作。NVMe 专为 SSD 设计，利用高速 PCIe 插槽在存储接口和系统 CPU 之间进行通信，不存在外形尺寸限制。
  * > NVMe 协议利用类似高性能处理器架构的并行、低延迟基础介质数据通道。***相比 `SAS` 和 `SATA` 协议，这大幅提升了性能并降低了延迟。NVMe可以支持多个 I/O 队列，最多可达 `64000` 个，而每个队列包含 `64000` 个条目***。相比采 AHCI（高级主控接口）等传统驱动程序的旧存储模型，NVMe 让输入/输出任务可以更快地传输更多数据。由于 NVMe专为 SSD 设计，它最终将成为新的行业标准。
- > **SSD 存储：过去与现在**
  * > ![](https://media.kingston.com.cn/kingston/content/ktc-content-nvme-general-data-buses-graph-cn-1.jpg)
  * > 数据总线在系统内传输数据，当基于 NAND 的 SSD 一经面世，行业就意识到推出新的总线和协议势在必行。
    + > 第一代 SSD 速度相对较慢，因而便于利用现有的 SATA 存储基础架构。***尽管 SATA 总线已发展到 `16Gbps`，但几乎所有 SATA 总线的商业实现仍维持在 `6Gbps`***。
    + > PCIe 3.0 的总吞吐率为 16Gbps，而 PCIe 4.0 的吞吐率是 PCIe 3.0 的两倍。它提供多达 16 个通道，数据传输速度高达 `32,000MB/秒`，而 SATA III 最高传输速度仅为 `600MB/秒`。
  * > 利用现有更高带宽总线技术的决定将 SATA 协议替换为 PCIe 技术。***PCIe 存储的出现比 NVMe 早几年，但以往的解决方案受到 SATA 和 AHCI 等较旧数据传输协议的瓶颈限制，导致 PCIe 存储无法发挥全部潜力，直到最近几年这种局面才有所改变***。NVMe 正是这种瓶颈的解决方案，提供低延迟命令和 64000 个队列，消除了各种限制因素。多队列设计可以提高数据传输速度，因为数据是利用芯片和块以分散形式写入 SSD 的，而不是像机械硬盘一样在旋转的磁盘上写入数据。
- > **`通信驱动器程序`：`AHCI` 与 `NVMe`**
  * > ![](https://media.kingston.com.cn/kingston/content/ktc-content-nvme-general-communication-drivers-graph-cn-2.jpg)
  * > ***通信驱动程序被操作系统用来与存储设备交换数据。NVMe 驱动程序比常见于 SATA 接口的 AHCI 驱动程序速度快***。
    + > ***NVMe专为采用闪存技术的 SSD 设计，速度远超专为采用旋转磁盘技术的普通机械硬盘设计的 AHCI 驱动程序***。
    + > ***NVMe 拥有 `64000` 个命令队列，可以每个队列发送 `64000` 条命令，而 AHCI 只有一个命令队列，每个队列只能发送 32 条命令***。
    + > ***利用 AHCI 驱动程序，命令利用高 CPU 周期，延迟为 `6 微秒`，而 NVMe 驱动程序命令利用低 CPU 周期，延迟为 `2.8 微秒`***。
  * > ***<ins>NVMe驱动程序直接与系统 CPU 通信，而 AHCI 必须与 SATA 控制器通信</ins>。AHCI 的 IOPS（每秒输入/输出操作）最高 `10 万`，而 NVMe 的 IOPS 超过 `100 万`***。IOPS（每秒输入/输出操作，发音是 i-ops）是用来对计算机存储设备进行基准测试的常见性能衡量指标。
- > **NVMe SSD 外形尺寸**
  * > ![](https://media.kingston.com.cn/kingston/content/ktc-content-nvme-general-ssd-form-factors-graph-cn-3.jpg)
  * > NVMe SSD 存在多种不同的外形尺寸，但具体取决于用例或应用。
    + > 个人/客户端产品使用 BGA 和 M.2 外形尺寸。
    + > 数据中心/服务器应用使用 M.2、U.2、U.3 和 EDSFF 外形尺寸。
  * > 目前业界正在针对 EDSFF（企业和数据中心 SSD 外形尺寸）制定标准和推动相关工作，EDSFF 提供一个动态范围的外形尺寸和标准，共用相同的协议 (NVMe)、相同的接口 (PCIe)，并使用它们自己的边缘连接器 (SFF-TA-1002)、引脚分配和功能 (SFF-TA-1009)。

NVM Express https://zh.wikipedia.org/wiki/NVM_Express
- > **背景**
  * > 历史上，大多数SSD使用如SATA、SAS或光纤通道等接口与计算机接口的总线连接。随着固态硬盘在大众市场上的流行，SATA已成为个人电脑中连接SSD的最典型方式；但是，***SATA的设计主要是作为机械硬盘驱动器（HDD）的接口，机械结构的HDD使用读取臂做读写，与直接操作固态颗粒的SSD差异很大，并随着时间的推移越来越难满足速度日益提高的SSD***。随着在大众市场的流行，许多固态硬盘的数据速率提升已经放缓。***不同于机械硬盘，部分SSD已受到SATA最大吞吐量的限制***。
  * > ***在NVMe出现之前，高端SSD只得以采用PCI Express总线制造，但需使用非标准规范的接口。若使用标准化的SSD接口，操作系统只需要一个驱动程序就能使用符合规范的所有SSD***。这也意味着每个SSD制造商不必用额外的资源来设计特定接口的驱动程序。
- > **PCI Express与传统的SATA差异**
  * > NVMe标准对比AHCI标准：
    + > 当数据从存储传输到服务器主机时，会进入一行或队列。传统的SATA连接只能支持一个队列，一次只能接收32条数据。而NVMe存储支持最多64000个队列，每个队列有64000个条目。
    + > NVMe使用原生PCIe通道，免去了SATA与SAS接口的主机控制器与CPU通信所带来的延时。NVMe标准的延时只有AHCI的一半不到：NVMe精简了调用方式，执行命令时不需要读取寄存器；而AHCI每条命令则需要读取4次寄存器，一共会消耗8000次CPU循环，从而造成大概2.5微秒的延迟。
    + > NVMe支持同时从多核处理器接受命令和优先处理请求，这在企业级的重负载时优势明显。
    + > NVMe加入了自动功耗状态切换和动态能耗管理功能。设备从Power State 0闲置50ms后可以切换到Power State 1；继续闲置的话，在500ms后又会进入功耗更低的Power State 2，切换时会有短暂延迟。SSD在闲置时可以非常快速的控制在极低的水平，在功耗管理上NVMe标准的SSD会比AHCI SSD拥有较大优势。
- > **历史**
  * > 2009年Intel开始着手寻找SATA的替代方案。SATA作为串行接口，采用AHCI规范，其已经成为制约SSD速度的瓶颈。AHCI只有1个命令队列，队列深度32。而NVMe可以有65535个命令队列，每个队列都可以深达65536个命令。NVMe也充分使用了MSI的2048个中断向量优势，延迟大大减小。最新的版本是2.0c；最大带宽约为16GB/s。
  * > 2018年，基于NVMe的SSD已经可以突破15TB可用容量，读带宽达到6GB/s，100万IOPS（4KB随机读），同时保证微秒级延迟。
