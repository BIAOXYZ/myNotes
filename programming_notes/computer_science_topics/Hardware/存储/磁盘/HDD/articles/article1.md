
# 1

磁盘I/O那些事 https://tech.meituan.com/2017/05/19/about-desk-io.html
- > **硬盘的物理结构**
  * > 早期的硬盘每磁道扇区数相同，此时由磁盘基本参数可以计算出硬盘的容量：`存储容量 = 磁头数 * 磁道（柱面）数 * 每道扇区数 * 每扇区字节数`。由于每磁道扇区数相同，外圈磁道半径大，里圈磁道半径小，外圈和里圈扇区面积自然会不一样。同时，为了更好的读取数据，即使外圈扇区面积再大也只能和内圈扇区一样存放相同的字节数（512字节）。***这样一来，外圈的记录密度就要比内圈小，会浪费大量的存储空间***。
  * > 如今的硬盘都使用`ZBR`（`Zoned Bit Recording`，`区位记录`）技术，盘片表面由里向外划分为数个区域，不同区域的磁道扇区数目不同，同一区域内各磁道扇区数相同，盘片外圈区域磁道长扇区数目较多，内圈区域磁道短扇区数目较少，***大体实现了等密度，从而获得了更多的存储空间***。此时，由于每磁道扇区数各不相同，所以传统的容量计算公式就不再适用。实际上如今的硬盘大多使用`LBA`（`Logical Block Addressing`）`逻辑块寻址模式`，知道LBA后即可计算出硬盘容量。
- > **影响硬盘性能的因素**
  * > 影响磁盘的关键因素是`磁盘服务时间`，***即磁盘完成一个I/O请求所花费的时间***，它由`寻道时间`、`旋转延迟`和`数据传输时间`三部分构成。
  * > **1. 寻道时间**
    + > Tseek是指将读写磁头移动至正确的磁道上所需要的时间。寻道时间越短，I/O操作越快，***目前磁盘的平均寻道时间一般在`3-15ms`***。
  * > **2. 旋转延迟**
    + > Trotation是指盘片旋转将请求数据所在的扇区移动到读写磁盘下方所需要的时间。***<ins>旋转延迟取决于`磁盘转速`，通常用磁盘旋转一周所需时间的1/2表示</ins>***。比如：***`7200rpm`的磁盘平均旋转延迟大约为`60*1000/7200/2 = 4.17ms`，而转速为`15000rpm`的磁盘其平均旋转延迟为`2ms`***。
  * > **3. 数据传输时间**
    + > Ttransfer是指完成传输所请求的数据所需要的时间，***它取决于`数据传输率`，其值等于数据大小除以数据传输率。目前`IDE/ATA`能达到`133MB/s`，`SATA II`可达到`300MB/s`的接口数据传输率，<ins>数据传输时间通常远小于前两部分消耗时间。简单计算时可忽略<ins>***。
- > **衡量性能的指标**
  * > ***<ins>机械硬盘的连续读写性能很好，但随机读写性能很差</ins>，这主要是因为磁头移动到正确的磁道上需要时间，随机读写时，磁头需要不停的移动，时间都浪费在了磁头寻址上，所以性能不高***。衡量磁盘的重要主要指标是`IOPS`和`吞吐量`。
  * > **1. IOPS**
    + > ***`IOPS`（`Input/Output Per Second`）即每秒的输入输出量（或读写次数），即指每秒内系统能处理的I/O请求数量。<ins>随机读写频繁的应用，如`小文件存储`等，关注随机读写性能，IOPS是关键衡量指标</ins>***。可以推算出磁盘的 `IOPS = 1000ms / (Tseek + Trotation + Transfer)`，如果忽略数据传输时间，理论上可以计算出随机读写最大的IOPS。常见磁盘的随机读写最大IOPS为：
      ```console
      7200rpm的磁盘 IOPS = 76 IOPS
      10000rpm的磁盘IOPS = 111 IOPS
      15000rpm的磁盘IOPS = 166 IOPS
      ```
  * > **2. 吞吐量**
    + > ***`吞吐量`（`Throughput`），指单位时间内可以成功传输的数据数量。<ins>顺序读写频繁的应用，如`视频点播`，关注连续读写性能、数据吞吐量是关键衡量指标</ins>。它主要取决于磁盘阵列的架构，通道的大小以及磁盘的个数***。不同的磁盘阵列存在不同的架构，但他们都有自己的内部带宽，一般情况下，内部带宽都设计足够充足，不会存在瓶颈。***磁盘阵列与服务器之间的数据通道对吞吐量影响很大，比如一个`2Gbps`的光纤通道，其所能支撑的最大流量仅为`250MB/s`***。最后，当前面的瓶颈都不再存在时，硬盘越多的情况下吞吐量越大。
- > **操作系统层的优化**
  * > 虽然`15000rpm`的磁盘计算出的理论最大IOPS仅为`166`，但在实际运行环境中，实际磁盘的IOPS往往能够突破`200`甚至更高。这其实就是在系统调用过程中，操作系统进行了一系列的优化。
  * > 那么操作系统是如何操作硬盘的呢？类似于网络的分层结构，下图显示了Linux系统中对于磁盘的一次读请求在核心空间中所要经历的层次模型。从图中看出：对于磁盘的一次读请求，首先经过`虚拟文件系统层`（VFS Layer），其次是`具体的文件系统层`（例如Ext2），接下来是`Cache层`（Page Cache Layer）、`通用块层`（Generic Block Layer）、`I/O调度层`（I/O Scheduler Layer）、`块设备驱动层`（Block Device Driver Layer），最后是`物理块设备层`（Block Device Layer）。
  * > ![](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/6e034503.png)
- > **虚拟文件系统层（VFS Layer）**
  * > `VFS`（`Virtual File System`）`虚拟文件系统`是一种软件机制，更确切的说扮演着文件系统管理者的角色，***与它相关的数据结构只存在于物理内存当中***。它的作用是：屏蔽下层具体文件系统操作的差异，为上层的操作提供一个统一的接口。***正是因为有了这个层次，Linux中允许众多不同的文件系统共存并且对文件的操作可以跨文件系统而执行***。
  * > VFS中包含着向物理文件系统转换的一系列数据结构，***如VFS超级块、VFS的Inode、各种操作函数的转换入口等***。Linux中VFS依靠四个主要的数据结构来描述其结构信息，分别为`超级块`、`索引结点`、`目录项`和`文件对象`。
    + > 1.`超级块`（`Super Block`）：超级块对象表示一个文件系统。它存储一个已安装的文件系统的控制信息，包括文件系统名称（比如Ext2）、文件系统的大小和状态、块设备的引用和元数据信息（比如空闲列表等等）。VFS超级块存在于内存中，它在文件系统安装时建立，并且在文件系统卸载时自动删除。同时需要注意的是对于每个具体的文件系统来说，也有各自的超级块，它们存放于磁盘。
    + > 2.`索引结点`（`Inode`）：索引结点对象存储了文件的相关元数据信息，例如：文件大小、设备标识符、用户标识符、用户组标识符等等。Inode分为两种：一种是VFS的Inode，一种是具体文件系统的Inode。前者在内存中，后者在磁盘中。所以每次其实是将磁盘中的Inode调进填充内存中的Inode，这样才是算使用了磁盘文件Inode。当创建一个文件的时候，就给文件分配了一个Inode。一个Inode只对应一个实际文件，一个文件也会只有一个Inode。
    + > 3.`目录项`（`Dentry`）：引入目录项对象的概念主要是出于方便查找文件的目的。不同于前面的两个对象，目录项对象没有对应的磁盘数据结构，只存在于内存中。一个路径的各个组成部分，不管是目录还是普通的文件，都是一个目录项对象。如，在路径/home/source/test.java中，目录 /, home, source和文件 test.java都对应一个目录项对象。VFS在查找的时候，根据一层一层的目录项找到对应的每个目录项的Inode，那么沿着目录项进行操作就可以找到最终的文件。
    + > 4.`文件对象`（`File`）：文件对象描述的是进程已经打开的文件。因为一个文件可以被多个进程打开，所以一个文件可以存在多个文件对象。一个文件对应的文件对象可能不是惟一的，但是其对应的索引节点和目录项对象肯定是惟一的。
- > **Ext2文件系统**
- > **Page Cache层**
- > **通用块层**
- > **I/O调度层**
- > **块设备驱动层**
- > **基于磁盘I/O特性设计的技巧**
  * > **采用追加写**
  * > **文件合并和元数据优化**
    + > **小文件合并**
    + > **元数据管理优化**
