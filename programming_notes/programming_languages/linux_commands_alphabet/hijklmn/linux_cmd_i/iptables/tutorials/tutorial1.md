
# 1

【from `朱双印个人日志`】iptables详解系列 http://www.zsythink.net/archives/tag/iptables/

:u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307:

iptables详解（1）：iptables概念 https://www.zsythink.net/archives/1199
- > **防火墙相关概念**
  * > 从逻辑上讲。防火墙可以大体分为主机防火墙和网络防火墙。
  * > 从物理上讲，防火墙可以分为硬件防火墙和软件防火墙。
  * > `iptables`其实不是真正的防火墙，我们可以把它理解成一个客户端代理，用户通过iptables这个代理，将用户的安全设定执行到对应的”安全框架”中，这个”安全框架”才是真正的防火墙，这个框架的名字叫`netfilter`
  * > `netfilter`才是防火墙真正的安全框架（framework），***`netfilter`位于内核空间***。
  * > ***`iptables`其实是一个命令行工具，位于用户空间***，我们用这个工具操作真正的框架。
  * > 所以说，虽然我们使用service iptables start启动iptables”服务”，但是其实准确的来说，iptables并没有一个守护进程，所以并不能算是真正意义上的服务，而应该算是内核提供的功能。
- > **iptables基础**
  * > 我们知道iptables是按照规则来办事的，我们就来说说`规则（rules）`，规则其实就是网络管理员预定义的条件，***规则一般的定义为”如果数据包头符合这样的条件，就这样处理这个数据包”***。规则存储在内核空间的信息包过滤表中，这些规则分别指定了源地址、目的地址、传输协议（如TCP、UDP、ICMP）和服务类型（如HTTP、FTP和SMTP）等。当数据包与规则匹配时，iptables就根据规则所定义的方法来处理这些数据包，如放行（accept）、拒绝（reject）和丢弃（drop）等。配置防火墙的主要工作就是添加、修改和删除这些规则。
  * > 这样说可能并不容易理解，我们来换个容易理解的角度，从头说起.
  * > 当客户端访问服务器的web服务时，客户端发送报文到网卡，而tcp/ip协议栈是属于内核的一部分，所以，客户端的信息会通过内核的TCP协议传输到用户空间中的web服务中，而此时，客户端报文的目标终点为web服务所监听的套接字（IP：Port）上，当web服务需要响应客户端请求时，web服务发出的响应报文的目标终点则为客户端，这个时候，web服务所监听的IP与端口反而变成了原点，我们说过，netfilter才是真正的防火墙，它是内核的一部分，所以，如果我们想要防火墙能够达到”防火”的目的，则需要在内核中设置关卡，所有进出的报文都要通过这些关卡，经过检查后，符合放行条件的才能放行，符合阻拦条件的则需要被阻止，于是，就出现了input关卡和output关卡，**而这些关卡在iptables中不被称为”关卡”,而被称为`”链”`**。 <br> ![](https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_1.png)
  * > ***其实我们上面描述的场景并不完善，因为客户端发来的报文访问的目标地址可能并不是本机，而是其他服务器***，当本机的内核支持`IP_FORWARD`时，我们可以将报文转发给其他服务器，所以，这个时候，我们就会提到iptables中的其他”关卡”，也就是其他”链”，他们就是 “路由前”、”转发”、”路由后”，他们的英文名是 `PREROUTING`、`FORWARD`、`POSTROUTING`
  * > 也就是说，当我们启用了防火墙功能时，报文需要经过如下关卡，也就是说，根据实际情况的不同，报文经过”链”可能不同。如果报文需要转发，那么报文则不会经过input链发往用户空间，而是直接在内核空间中经过forward链和postrouting链转发出去的。 <br> ![](https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_2.png)
- > **`链`的概念**
  * > 现在，我们想象一下，这些”关卡”在iptables中为什么被称作”链”呢？我们知道，防火墙的作用就在于对经过的报文匹配”规则”，然后执行对应的”动作”,所以，当报文经过这些关卡的时候，则必须匹配这个关卡上的规则，***但是，这个关卡上可能不止有一条规则，而是有很多条规则，<ins>当我们把这些规则串到一个链条上的时候，就形成了`”链”`</ins>***,所以，***我们把每一个”关卡”想象成如下图中的模样***，这样来说，把他们称为”链”更为合适，每个经过这个”关卡”的报文，都要将这条”链”上的所有规则匹配一遍，如果有符合条件的规则，则执行规则对应的动作。 <br> ![](https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_3.png)
- > **`表`的概念**
  * > 我们再想想另外一个问题，我们对每个”链”上都放置了一串规则，但是这些规则有些很相似，比如，A类规则都是对IP或者端口的过滤，B类规则是修改报文，那么这个时候，我们是不是能把实现相同功能的规则放在一起呢，必须能的。
  * > ***<ins>我们把具有相同功能的规则的集合叫做`”表”`</ins>***，所以说，不同功能的规则，我们可以放置在不同的表中进行管理，而iptables已经为我们定义了`4种`表，每种表对应了不同的功能，而我们定义的规则也都逃脱不了这4种功能的范围，所以，学习iptables之前，我们必须先搞明白每种表的作用。
  * > ***iptables为我们提供了如下规则的分类，或者说，iptables为我们提供了如下”表”***
    ```console
    filter表：负责过滤功能，防火墙；内核模块：iptables_filter
    nat表：network address translation，网络地址转换功能；内核模块：iptable_nat
    mangle表：拆解报文，做出修改，并重新封装 的功能；iptable_mangle
    raw表：关闭nat表上启用的连接追踪机制；iptable_raw
    ```
  * > 也就是说，我们自定义的所有规则，都是这四种分类中的规则，或者说，***所有规则都存在于这4张”表”中***。
- > **表链关系**
  * > 但是我们需要注意的是，***某些”链”中注定不会包含”某类规则”，就像某些”关卡”天生就不具备某些功能一样***，比如，A”关卡”只负责打击陆地敌人，没有防空能力，B”关卡”只负责打击空中敌人，没有防御步兵的能力，C”关卡”可能比较NB，既能防空，也能防御陆地敌人，D”关卡”最屌，海陆空都能防。
  * > 那让我们来看看，每个”关卡”都有哪些能力，或者说，让我们看看每个”链”上的规则都存在于哪些”表”中。
  * > 我们还是以图为例，先看看`prerouting”链”`上的规则都存在于哪些表中。
  * > **注意：下图只用于说明`prerouting链`上的规则存在于哪些表中，并没有描述表的顺序**。
  * > ![](https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_4.png) <br> 这幅图是什么意思呢？它的意思是说，prerouting”链”只拥有nat表、raw表和mangle表所对应的功能，所以，prerouting中的规则只能存放于nat表、raw表和mangle表中。
  * > 那么，根据上述思路，我们来总结一下，每个”关卡”都拥有什么功能，或者说，每个”链”中的规则都存在于哪些”表”中。
    ```console
    PREROUTING      的规则可以存在于：raw表，mangle表，nat表。
    INPUT           的规则可以存在于：mangle表，filter表，（centos7中还有nat表，centos6中没有）。
    FORWARD         的规则可以存在于：mangle表，filter表。
    OUTPUT          的规则可以存在于：raw表mangle表，nat表，filter表。
    POSTROUTING     的规则可以存在于：mangle表，nat表。
    ```

:u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307::u6307:

:u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272::u5272:
