
# 04

clickhouse 实时数据更新方案求助 https://www.v2ex.com/t/1123606
```console
各位大佬架构师们，紧急求助

我们有个报表类的需求，目前架构设计如下

数据量：1TB 左右 数据流转流程 业务数据->（ kafka 、flink ）->数据仓库（ MySQL)->通过 ETL 抽取->Clickhouse->报表呈现

由于我们报表对实时性要求比较高，而且在生成报表的时候涉及到的表多、逻辑也复杂，不得已我们将数据仓库的数据原封不动的同步到了 clickhouse ，后面在进行报表生成计算的时候，全部查 clickhouse 的数据最后生成大宽表。

我知道 clickhouse 是列式存储，对数据得删除和更新都是重量级操作，而我们的数据都是业务数据，更新比较频繁，所以我们采用了先删后插的策略，alter table delete (同步删非异步）。

这就导致我们的数据更新周期最低也要 1 个小时

之前考虑个几种方案

使用 ReplacingMergeTree 引擎，只追加数据，不删除，然后查询通过 final 或这 argMax 取最新数据，但是这有两个问题，一：final 没办法进行表关联查询， 二：argMax 对我们改动太大太大，表字段页表字段也比非常多（ 100+)
对于实时性要求高的报表 不再去查 clickhouse ， 直接查数据仓库
我比较中意第二种，因为我是在想不出更好的方案了，想请教下各位架构师们有没有比较好的方案

在此拜谢
```
```console
谢谢各位架构师大佬

总结一下

clickhouse 不是和数据频繁更新的场景，所以针对我的这个场景需求，就不用再去折腾 clickhouse ，无论是表分区还是更改表引擎，终究满足不了实时或接近实时的效果。如果是那种日志、埋点类的数据使用 clickhouse 还是非常不错的

针对数据频繁更新的场景，大佬们推荐使用 doris 和 starrocks

我也简单的了解了下，这两个库确实对数据频繁更新的场景比较友好，而且我只需要设置主键，然后不断的往里插数据就行了，还不用写 update 语句，很符合我们的业务场景。

接下来我尝试测试 doris 库，没问题就正常应用了。

再次拜谢各位大佬
```
- > 可以看下 物化视图 是不是能够解决，我们当时是 通过物化视图生成 聚合表。
  >> 之前了解过物化视图，只能监听到源表新增的数据，如果数据变更 是不会触发物化视图的，不太适合我们的场景 T.T
  >>> #3 如果实时性要求没那么高，可以手动触发
  >>>> 我们对实时性要求很高，想数据发生变化后 立刻就能看到报表的变化，最少也得 5-10 分，但这个数据量要同步更新到 clickhouse 以及跑宽表 ，这么短时间确实不太好做到
- > 最近再调研数据库，原先也准备用 clickhouse ，后面发现 doris 更适合，数据更新上支持也更好
- > 换 starrocks 或者 doris, clickhouse 不适合这个场景
- > 简单，打宽放到计算引擎去做，状态过大就把维表数据放 Hbase ，CK 提供对外查询。这点数据，优化都不用做，建好主键随便查
- > 数据加上版本号，再有一个地方记录最新的版本号，查询时带上版本号，这样感觉可行
- > 之前我们也遇到需要实时更新的，几种方案试过之后放弃了，换成了 doris
- > 有实时的建议不要用 ck ，或者每次查询用 final 做个强制同步（很占 cpu 和内存）
- > 跟我前司架构比较像（物联网行业）。我们当时的架构方案：使用 `VersionedCollapsingMergeTree` ，可以在表数据只追加的情况下，通过查询取得最新状态的数据。然后定时 optimize 表就行。
- > ***`ReplacingMergeTree` 在查询时会降低性能，物化视图也有严重的性能问题***。如果你们的 clickhouse 版本比较新，可以试试一个轻量删除（ https://clickhouse.com/docs/zh/guides/developer/lightweight-delete ）的特性。***doris 的资源占用和性能，没有 clickhouse 那么优秀，相等的查询速度需要的资源至少是 clickhouse 的三四倍***。没有万金油，***如果你们的数据频繁更新其实不大适合 clickhouse***
- > 我有个跟你类似的需求，用的是 Starrocks ，sr 使用聚合索引表，需要经常更新的值设置成 replace 聚合，每次新插入就更新了。目前 4T+数据
- > doris 或 starrocks ，这俩本质上差不多，没有二次开发能力不要碰 clickhouse
- > 如果必须是 Ck 我可以提供一个思路，就是分区 REPLACE ，每次更新就建一个复制表 写入之后就 REPLACE 分区，这样基本都是平滑且是 O1 ，然后更新频次就看写入速度了 可以小小参考一下： https://kelovp.tech/nostring/blog/1712/
- > doris 和 sr 已经开始有功能上的差异了,更推荐 doris. 比如加列,doris 快速加列功能很好用.而 sr 加列很慢 如果是阿里云,推荐阿里云的 hologres
